<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ‘çš„æ—…éŠè¦åŠƒå¤§å¸«</title>
    <style>
        :root { --primary: #1A73E8; --hotel-color: #F9AB00; --bg: #f8f9fa; --danger: #EA4335; --pending: #607D8B; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); padding: 10px; margin: 0; }
        
        /* ä¸Šæ–¹æ§åˆ¶é¢æ¿ */
        .setup-panel { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; text-align: center; }
        
        /* å¯ç·¨è¼¯æ¨™é¡Œæ¨£å¼ */
        .editable-title { 
            font-size: 24px; font-weight: bold; color: var(--primary); 
            border: none; text-align: center; width: 100%; margin-bottom: 15px;
            outline: none; padding: 5px; border-bottom: 2px solid transparent; transition: 0.3s;
        }
        .editable-title:focus { border-bottom: 2px solid var(--primary); background: #f0f7ff; }

        .hotel-source-box { 
            background: #FFF9E1; border: 2px dashed var(--hotel-color); padding: 12px; 
            margin: 10px auto; border-radius: 10px; display: inline-block; cursor: grab;
            font-weight: bold; color: #856404;
        }

        .itinerary-wrapper { display: flex; gap: 20px; overflow-x: auto; padding-bottom: 20px; align-items: flex-start; height: calc(100vh - 250px); }
        
        .pending-card { min-width: 280px; background: #eceff1; border-radius: 12px; border: 2px dashed var(--pending); flex-shrink: 0; position: sticky; left: 0; z-index: 10; }
        .pending-header { padding: 15px; background: var(--pending); color: white; border-radius: 11px 11px 0 0; font-weight: bold; text-align: center; }

        .day-card { min-width: 320px; background: white; border-radius: 12px; border: 1px solid #ddd; flex-shrink: 0; }
        .day-header { padding: 15px; background: var(--primary); color: white; border-radius: 11px 11px 0 0; font-weight: bold; text-align: center; }
        
        .spot-list { padding: 15px; list-style: none; margin: 0; min-height: 200px; }
        .spot-item { 
            padding: 12px; border-radius: 8px; background: #fff; border: 1px solid #eee; 
            display: flex; justify-content: space-between; align-items: center; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: grab; margin-bottom: 5px;
        }
        .spot-item.drag-over { border-top: 4px solid var(--primary); }
        .is-hotel { border-left: 5px solid var(--hotel-color); background: #FFFDF5; }
        
        .delete-btn { color: var(--danger); cursor: pointer; font-size: 16px; padding: 5px; }

        .route-link { display: flex; align-items: center; padding: 5px 0 10px 40px; text-decoration: none; color: var(--primary); font-size: 12px; position: relative; }
        .route-link::before { content: ""; position: absolute; left: 20px; top: -10px; bottom: 0; width: 2px; background: #eee; }
        .route-btn { background: #e8f0fe; padding: 2px 8px; border-radius: 4px; border: 1px solid #d2e3fc; }

        .add-area { padding: 12px; border-top: 1px solid #eee; display: flex; gap: 5px; }
        input, button { padding: 10px; border-radius: 6px; border: 1px solid #ddd; }
        .btn-add { background: var(--primary); color: white; border: none; cursor: pointer; }
        .btn-pending { background: var(--pending); }
        
        .save-hint { font-size: 12px; color: #4caf50; margin-top: 10px; display: none; }
    </style>
</head>
<body>

<div class="setup-panel">
    <input type="text" id="tripTitle" class="editable-title" value="æˆ‘çš„å¤§é˜ªæ—…éŠè¡Œç¨‹" oninput="saveData()">
    
    <div style="display:flex; gap:10px; justify-content:center; align-items:center; flex-wrap:wrap;">
        <input type="text" id="hotelName" value="å¤§é˜ªé›£æ³¢æ ¼æ‹‰æ–¯éº—é…’åº—" oninput="saveData()" style="border:1px solid var(--hotel-color); width:200px;">
        <input type="date" id="startDate" value="2026-02-16">
        <input type="date" id="endDate" value="2026-02-21">
        <button onclick="confirmReset()" class="btn-add">é‡è¨­æ—¥æœŸå€é–“</button>
    </div>
    <div class="hotel-source-box" draggable="true" ondragstart="dragStartTemplate(event)">
        ğŸ¨ æ‹–å‹•é£¯åº—é›¶ä»¶ (æ’å…¥è¡Œç¨‹)
    </div>
    <div id="saveHint" class="save-hint">âœ“ å·²è‡ªå‹•å„²å­˜è‡³æœ¬åœ°</div>
</div>

<div class="itinerary-wrapper">
    <div class="pending-card">
        <div class="pending-header">ğŸ“‹ å¾…å®‰æ’æ™¯é»</div>
        <div class="spot-list" id="list-pending" ondragover="handleDragOver(event)" ondrop="handleDrop(event, 'pending')"></div>
        <div class="add-area">
            <input type="text" id="input-pending" placeholder="æƒ³å»å“ªï¼Ÿ" style="flex:1">
            <button class="btn-add btn-pending" onclick="addNewSpot('pending')">ï¼‹</button>
        </div>
    </div>
    <div id="dailyContainer" style="display:contents;"></div>
</div>

<script>
    // åˆå§‹è³‡æ–™çµæ§‹
    let tripData = { 
        "title": "æˆ‘çš„å¤§é˜ªæ—…éŠè¡Œç¨‹",
        "hotel": "å¤§é˜ªé›£æ³¢æ ¼æ‹‰æ–¯éº—é…’åº—",
        "days": { "pending": [] } 
    };

    // 1. æœ¬åœ°å„²å­˜åŠŸèƒ½ï¼šè®€å–
    window.onload = function() {
        const localData = localStorage.getItem('myTripDataV3');
        if (localData) {
            tripData = JSON.parse(localData);
            document.getElementById('tripTitle').value = tripData.title || "æˆ‘çš„æ—…éŠè¡Œç¨‹";
            document.getElementById('hotelName').value = tripData.hotel || "";
            refreshUI();
        } else {
            initTrip();
        }
    };

    function confirmReset() {
        if (confirm("é‡è¨­æ—¥æœŸæœƒæ¸…é™¤ã€Œå·²æ’å¥½ã€çš„è¡Œç¨‹ï¼Œä½†æœƒä¿ç•™ã€Œå¾…å®‰æ’ã€çš„æ™¯é»ã€‚ç¢ºå®šå—ï¼Ÿ")) {
            initTrip();
        }
    }

    function initTrip() {
        const start = new Date(document.getElementById('startDate').value);
        const end = new Date(document.getElementById('endDate').value);
        const oldPending = tripData.days["pending"] || [];
        
        tripData.days = { "pending": oldPending };
        let current = new Date(start);
        while (current <= end) {
            const dateStr = current.toISOString().split('T')[0];
            tripData.days[dateStr] = [];
            current.setDate(current.getDate() + 1);
        }
        saveData();
        refreshUI();
    }

    function refreshUI() {
        const dailyContainer = document.getElementById('dailyContainer');
        dailyContainer.innerHTML = '';
        
        // å–å¾—æ‰€æœ‰æ—¥æœŸä¸¦æ’åº
        const dates = Object.keys(tripData.days).filter(d => d !== 'pending').sort();
        
        dates.forEach((dateStr, idx) => {
            const dayCard = document.createElement('div');
            dayCard.className = 'day-card';
            dayCard.innerHTML = `
                <div class="day-header">Day ${idx + 1} - ${dateStr}</div>
                <div class="spot-list" id="list-${dateStr}" ondragover="handleDragOver(event)" ondrop="handleDrop(event, '${dateStr}')"></div>
                <div class="add-area">
                    <input type="text" id="input-${dateStr}" placeholder="æ–°å¢é»..." style="flex:1">
                    <button class="btn-add" onclick="addNewSpot('${dateStr}')">ï¼‹</button>
                </div>
            `;
            dailyContainer.appendChild(dayCard);
        });
        renderAllSpots();
    }

    // å„²å­˜è‡³ LocalStorage
    function saveData() {
        tripData.title = document.getElementById('tripTitle').value;
        tripData.hotel = document.getElementById('hotelName').value;
        localStorage.setItem('myTripDataV3', JSON.stringify(tripData));
        
        // é¡¯ç¤ºå„²å­˜æç¤º
        const hint = document.getElementById('saveHint');
        hint.style.display = 'block';
        setTimeout(() => hint.style.display = 'none', 1000);
    }

    function dragStartItem(ev, dateStr, index) {
        ev.dataTransfer.setData("type", "EXISTING");
        ev.dataTransfer.setData("date", dateStr);
        ev.dataTransfer.setData("index", index);
    }

    function dragStartTemplate(ev) {
        ev.dataTransfer.setData("type", "TEMPLATE");
        ev.dataTransfer.setData("name", document.getElementById('hotelName').value);
    }

    function handleDragOver(ev) {
        ev.preventDefault();
        const target = ev.target.closest('.spot-item');
        document.querySelectorAll('.spot-item').forEach(el => el.classList.remove('drag-over'));
        if (target) target.classList.add('drag-over');
    }

    function handleDrop(ev, destDate) {
        ev.preventDefault();
        document.querySelectorAll('.spot-item').forEach(el => el.classList.remove('drag-over'));
        const type = ev.dataTransfer.getData("type");
        const targetElement = ev.target.closest('.spot-item');
        let insertIndex = tripData.days[destDate].length;
        if (targetElement) {
            const listItems = Array.from(targetElement.parentNode.children).filter(el => el.classList.contains('spot-item'));
            insertIndex = listItems.indexOf(targetElement);
        }

        if (type === "TEMPLATE") {
            tripData.days[destDate].splice(insertIndex, 0, ev.dataTransfer.getData("name"));
        } else {
            const srcDate = ev.dataTransfer.getData("date");
            const srcIdx = parseInt(ev.dataTransfer.getData("index"));
            const item = tripData.days[srcDate].splice(srcIdx, 1)[0];
            let adjIdx = (srcDate === destDate && srcIdx < insertIndex) ? insertIndex - 1 : insertIndex;
            tripData.days[destDate].splice(adjIdx, 0, item);
        }
        saveData();
        renderAllSpots();
    }

    function addNewSpot(dateStr) {
        const input = document.getElementById(`input-${dateStr}`);
        if (input.value.trim()) {
            tripData.days[dateStr].push(input.value.trim());
            input.value = '';
            saveData();
            renderAllSpots();
        }
    }

    function renderAllSpots() {
        for (let dateStr in tripData.days) {
            const list = document.getElementById(`list-${dateStr}`);
            if (!list) continue;
            list.innerHTML = '';
            tripData.days[dateStr].forEach((name, idx) => {
                const item = document.createElement('div');
                item.className = `spot-item ${name === tripData.hotel ? 'is-hotel' : ''}`;
                item.draggable = true;
                item.ondragstart = (e) => dragStartItem(e, dateStr, idx);
                item.innerHTML = `<span>${name}</span><span class="delete-btn" onclick="removeSpot('${dateStr}', ${idx})">âœ•</span>`;
                list.appendChild(item);

                if (dateStr !== 'pending' && idx < tripData.days[dateStr].length - 1) {
                    const from = encodeURIComponent(tripData.days[dateStr][idx]);
                    const to = encodeURIComponent(tripData.days[dateStr][idx+1]);
                    const link = document.createElement('a');
                    link.className = 'route-link';
                    link.href = `https://www.google.com/maps/dir/?api=1&origin=${from}&destination=${to}&travelmode=transit`;
                    link.target = "_blank";
                    link.innerHTML = `<span class="route-btn">æŸ¥çœ‹è·¯å¾‘</span>`;
                    list.appendChild(link);
                }
            });
        }
    }

    function removeSpot(dateStr, idx) {
        tripData.days[dateStr].splice(idx, 1);
        saveData();
        renderAllSpots();
    }
</script>
</body>
</html>