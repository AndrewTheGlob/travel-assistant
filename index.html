<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤§é˜ªæ—…éŠåŠ©æ‰‹ Ultimate</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>
    <style>
        :root { --primary: #1A73E8; --hotel-color: #F9AB00; --bg: #f8f9fa; --danger: #EA4335; --pending: #607D8B; --share: #34A853; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); padding: 0; margin: 0; }
        
        /* é ‚éƒ¨æ§åˆ¶å° */
        .setup-panel { background: white; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; z-index: 200; position: relative; }
        .editable-title { font-size: 20px; font-weight: bold; color: var(--primary); border: none; text-align: center; width: 100%; outline: none; margin-bottom: 8px; }

        .share-control { display: flex; gap: 8px; justify-content: center; margin-bottom: 10px; }
        .btn-share { background: var(--share); color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; }

        .hotel-source-box { background: #FFF9E1; border: 2px dashed var(--hotel-color); padding: 8px 15px; margin: 5px auto; border-radius: 10px; display: inline-block; cursor: grab; font-weight: bold; color: #856404; font-size: 14px; touch-action: none; }

        /* æ ¸å¿ƒä½ˆå±€ï¼šæ‰‹æ©Ÿç‰ˆå¾…å®‰æ’å€å›ºå®šåœ¨é ‚éƒ¨ */
        .itinerary-wrapper { display: flex; flex-direction: column; gap: 15px; padding: 15px; }
        
        /* å¾…å®‰æ’å€ï¼šæ‰‹æ©Ÿç‰ˆæ‡¸æµ®å›ºå®š */
        .pending-card { 
            background: #eceff1; border-radius: 12px; border: 2px dashed var(--pending); 
            position: sticky; top: 10px; z-index: 150; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            max-height: 200px; display: flex; flex-direction: column;
        }
        .pending-content { overflow-y: auto; padding: 10px; transition: max-height 0.3s ease; }
        .pending-card.collapsed .pending-content { display: none; }

        @media (min-width: 768px) {
            .itinerary-wrapper { flex-direction: row; overflow-x: auto; height: calc(100vh - 250px); align-items: flex-start; }
            .pending-card { min-width: 280px; top: 0; max-height: 100%; }
            .pending-content { display: block !important; }
        }

        /* æ—¥æœŸå¡ç‰‡èˆ‡æ‘ºç–Šé‚è¼¯ */
        .day-card { min-width: 100%; background: white; border-radius: 12px; border: 1px solid #ddd; overflow: hidden; }
        .day-card.collapsed .spot-list, .day-card.collapsed .add-area { display: none; }
        
        @media (min-width: 768px) { .day-card { min-width: 320px; } }
        
        .header-bar { padding: 12px; color: white; font-weight: bold; text-align: center; cursor: pointer; display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; }
        .day-header { background: var(--primary); }
        .pending-header { background: var(--pending); }
        .toggle-arrow { font-size: 12px; transition: transform 0.3s; }
        .collapsed .toggle-arrow { transform: rotate(-90deg); }

        /* é …ç›®æ¨£å¼ï¼šå„ªåŒ–æ‰‹æ©Ÿé»æ“Šå€åŸŸ */
        .spot-list { padding: 10px; min-height: 60px; }
        .spot-item { 
            padding: 15px; border-radius: 8px; background: #fff; border: 1px solid #eee; 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 8px; font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
            cursor: grab; touch-action: none; /* ç¦ç”¨ç€è¦½å™¨é»˜èªè§¸æ§å‹•ä½œä»¥åˆ©æ‹–æ‹½ */
        }
        .spot-item:active { opacity: 0.7; scale: 0.98; }
        .spot-item.drag-over { border-top: 4px solid var(--primary); }
        .is-hotel { border-left: 5px solid var(--hotel-color); background: #FFFDF5; }
        
        .route-link { display: flex; align-items: center; padding: 0 0 10px 35px; text-decoration: none; color: var(--primary); font-size: 12px; position: relative; }
        .route-link::before { content: ""; position: absolute; left: 18px; top: -10px; bottom: 0; width: 2px; background: #ddd; }
        .route-btn { background: #e8f0fe; padding: 4px 10px; border-radius: 4px; border: 1px solid #d2e3fc; }

        .add-area { padding: 10px; border-top: 1px solid #eee; display: flex; gap: 5px; }
        input, button { padding: 10px; border-radius: 6px; border: 1px solid #ddd; }
        .btn-add { background: var(--primary); color: white; border: none; font-weight: bold; }
    </style>
</head>
<body>

<div class="setup-panel">
    <input type="text" id="tripTitle" class="editable-title" value="æˆ‘çš„å¤§é˜ªä¹‹æ—…" oninput="saveData()">
    <div class="share-control">
        <button class="btn-share" onclick="exportData()">ğŸ“¤ è¤‡è£½çŸ­ç¢¼</button>
        <button class="btn-share" onclick="importData()">ğŸ“¥ åŒ¯å…¥è¡Œç¨‹</button>
    </div>
    <div style="display:flex; gap:5px; justify-content:center; align-items:center; flex-wrap:wrap; margin-bottom: 10px;">
        <input type="text" id="hotelName" value="é£¯åº—" oninput="saveData()" style="width:80px;">
        <input type="date" id="startDate" value="2026-02-16" style="width:125px;">
        <span>è‡³</span>
        <input type="date" id="endDate" value="2026-02-21" style="width:125px;">
        <button onclick="confirmReset()" class="btn-add" style="padding: 6px; font-size:12px;">é‡è¨­æ—¥æœŸ</button>
    </div>
    <div class="hotel-source-box" draggable="true" ondragstart="dragStartTemplate(event)">ğŸ¨ é£¯åº—é›¶ä»¶ (æ‹–å‹•)</div>
</div>

<div class="itinerary-wrapper">
    <div class="pending-card" id="pendingCard">
        <div class="header-bar pending-header" onclick="toggleSection('pendingCard')">
            <span>ğŸ“‹ å¾…å®‰æ’å£è¢‹</span>
            <span class="toggle-arrow">â–¼</span>
        </div>
        <div class="pending-content">
            <div class="spot-list" id="list-pending" ondragover="handleDragOver(event)" ondrop="handleDrop(event, 'pending')"></div>
            <div class="add-area">
                <input type="text" id="input-pending" placeholder="æƒ³å»å“ªï¼Ÿ" style="flex:1">
                <button class="btn-add" style="background:var(--pending)" onclick="addNewSpot('pending')">ï¼‹</button>
            </div>
        </div>
    </div>
    <div id="dailyContainer" style="display:contents;"></div>
</div>

<script>
    let tripData = { t: "æˆ‘çš„å¤§é˜ªä¹‹æ—…", h: "é£¯åº—", d: { "pending": [] } };

    window.onload = function() {
        const local = localStorage.getItem('myTripV7_Ultimate');
        if (local) {
            tripData = JSON.parse(local);
            document.getElementById('tripTitle').value = tripData.t;
            document.getElementById('hotelName').value = tripData.h;
            refreshUI();
        } else { initTrip(); }
    };

    // æ‘ºç–Š/å±•é–‹åˆ‡æ›
    function toggleSection(id) {
        document.getElementById(id).classList.toggle('collapsed');
    }

    function initTrip() {
        const start = new Date(document.getElementById('startDate').value);
        const end = new Date(document.getElementById('endDate').value);
        if (end < start) return alert("æ—¥æœŸéŒ¯èª¤");
        const oldP = tripData.d["pending"] || [];
        tripData.d = { "pending": oldP };
        let cur = new Date(start);
        while (cur <= end) {
            tripData.d[cur.toISOString().split('T')[0]] = [];
            cur.setDate(cur.getDate() + 1);
        }
        saveData(); refreshUI();
    }

    function confirmReset() { if(confirm("ç¢ºå®šé‡è¨­æ—¥æœŸï¼Ÿå·²æ’è¡Œç¨‹å°‡æ¶ˆå¤±ã€‚")) initTrip(); }

    function refreshUI() {
        const container = document.getElementById('dailyContainer');
        container.innerHTML = '';
        const dates = Object.keys(tripData.d).filter(x => x !== 'pending').sort();
        dates.forEach((date, i) => {
            const dayId = `day-${date}`;
            const card = document.createElement('div');
            card.className = 'day-card';
            card.id = dayId;
            card.innerHTML = `
                <div class="header-bar day-header" onclick="toggleSection('${dayId}')">
                    <span>Day ${i+1} - ${date}</span>
                    <span class="toggle-arrow">â–¼</span>
                </div>
                <div class="spot-list" id="list-${date}" ondragover="handleDragOver(event)" ondrop="handleDrop(event, '${date}')"></div>
                <div class="add-area">
                    <input type="text" id="input-${date}" placeholder="æ–°å¢æ™¯é»..." style="flex:1">
                    <button class="btn-add" onclick="addNewSpot('${date}')">ï¼‹</button>
                </div>
            `;
            container.appendChild(card);
        });
        renderSpots();
    }

    function saveData() {
        tripData.t = document.getElementById('tripTitle').value;
        tripData.h = document.getElementById('hotelName').value;
        localStorage.setItem('myTripV7_Ultimate', JSON.stringify(tripData));
    }

    function exportData() {
        const compressed = LZString.compressToEncodedURIComponent(JSON.stringify(tripData));
        navigator.clipboard.writeText(compressed).then(() => alert("æ¥µçŸ­ç¢¼å·²è¤‡è£½ï¼"));
    }

    function importData() {
        const code = prompt("è«‹è²¼ä¸ŠçŸ­ç¢¼ï¼š");
        if (code) {
            try {
                const decomp = LZString.decompressFromEncodedURIComponent(code);
                if (decomp) { tripData = JSON.parse(decomp); saveData(); location.reload(); }
            } catch (e) { alert("ç„¡æ•ˆä»£ç¢¼"); }
        }
    }

    // æ‹–æ›³é‚è¼¯ä¿®å¾©
    function handleDragOver(ev) {
        ev.preventDefault();
        const target = ev.target.closest('.spot-item');
        document.querySelectorAll('.spot-item').forEach(el => el.classList.remove('drag-over'));
        if (target) target.classList.add('drag-over');
    }

    function handleDrop(ev, destDate) {
        ev.preventDefault();
        document.querySelectorAll('.spot-item').forEach(el => el.classList.remove('drag-over'));
        const type = ev.dataTransfer.getData("type");
        const targetElement = ev.target.closest('.spot-item');
        let insertIndex = tripData.d[destDate].length;
        
        if (targetElement) {
            const listItems = Array.from(targetElement.parentNode.children).filter(el => el.classList.contains('spot-item'));
            insertIndex = listItems.indexOf(targetElement);
        }

        if (type === "TEMPLATE") {
            tripData.d[destDate].splice(insertIndex, 0, document.getElementById('hotelName').value);
        } else {
            const srcDate = ev.dataTransfer.getData("date");
            const srcIdx = parseInt(ev.dataTransfer.getData("index"));
            const item = tripData.d[srcDate].splice(srcIdx, 1)[0];
            let adjIdx = (srcDate === destDate && srcIdx < insertIndex) ? insertIndex - 1 : insertIndex;
            tripData.d[destDate].splice(adjIdx, 0, item);
        }
        saveData(); renderSpots();
    }

    function dragStartTemplate(e) { e.dataTransfer.setData("type", "TEMPLATE"); }

    function addNewSpot(d) {
        const val = document.getElementById(`input-${d}`).value.trim();
        if (val) { tripData.d[d].push(val); document.getElementById(`input-${d}`).value = ''; saveData(); renderSpots(); }
    }

    function renderSpots() {
        const hotel = document.getElementById('hotelName').value;
        for (let d in tripData.d) {
            const list = document.getElementById(`list-${d}`); if (!list) continue;
            list.innerHTML = '';
            tripData.d[d].forEach((name, i) => {
                const item = document.createElement('div');
                item.className = `spot-item ${name === hotel ? 'is-hotel' : ''}`;
                item.draggable = true;
                item.ondragstart = (e) => {
                    e.dataTransfer.setData("type", "EXISTING");
                    e.dataTransfer.setData("date", d);
                    e.dataTransfer.setData("index", i);
                };
                item.innerHTML = `<span>${name}</span><span style="color:red; font-weight:bold; cursor:pointer;" onclick="removeSpot('${d}',${i})">âœ•</span>`;
                list.appendChild(item);
                if (d !== 'pending' && i < tripData.d[d].length - 1) {
                    const l = document.createElement('a'); l.className = 'route-link';
                    l.href = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(tripData.d[d][i])}&destination=${encodeURIComponent(tripData.d[d][i+1])}&travelmode=transit`;
                    l.target = "_blank"; l.innerHTML = `<span class="route-btn">æŸ¥çœ‹è·¯å¾‘</span>`;
                    list.appendChild(l);
                }
            });
        }
    }
    function removeSpot(d, i) { tripData.d[d].splice(i, 1); saveData(); renderSpots(); }
</script>
</body>
</html>
